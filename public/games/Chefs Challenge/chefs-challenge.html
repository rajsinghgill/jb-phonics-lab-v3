<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Perfect Pizza | AAA Phonics</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&display=swap');

        :root {
            --primary: #FF4757;
            --secondary: #2ED573;
            --accent: #FFA502;
            --dark: #2F3542;
            --light: #FFFFFF;
        }

        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background-color: #2F3542;
            overflow: hidden;
            font-family: 'Nunito', sans-serif;
            /* iOS Specific: Prevents scrolling, bouncing, and zooming */
            touch-action: none;
            user-select: none;
            -webkit-user-select: none;
            -webkit-touch-callout: none;
            -webkit-font-smoothing: antialiased;
        }

        /* --- BACKGROUND LAYER --- */
        #bg-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
        }

        /* --- GAME LAYER --- */
        #game-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            /* iOS: Removes the grey tap highlight box */
            -webkit-tap-highlight-color: transparent;
            cursor: pointer;
        }

        /* --- UI LAYER --- */
        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .hud-header {
            padding: 24px;
            /* Account for iPad Notch/Status Bar */
            padding-top: max(24px, env(safe-area-inset-top)); 
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .progress-pill {
            background: rgba(47, 53, 66, 0.9);
            backdrop-filter: blur(10px);
            padding: 12px 24px;
            border-radius: 50px;
            border: 2px solid rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.3);
        }

        .progress-label {
            color: #A4B0BE;
            font-weight: 800;
            font-size: 14px;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        .stars-container {
            display: flex;
            gap: 8px;
            font-size: 28px;
        }

        .star { opacity: 0.2; transform: scale(0.8); transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); filter: grayscale(1); }
        .star.active { opacity: 1; transform: scale(1.2); filter: grayscale(0); text-shadow: 0 0 15px #FFEAA7; }

        /* --- MODALS --- */
        .modal-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(47, 53, 66, 0.95);
            backdrop-filter: blur(15px);
            z-index: 20;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.4s ease;
        }

        .modal-overlay.visible {
            opacity: 1;
            pointer-events: auto;
        }

        .card {
            background: white;
            width: 85%;
            max-width: 450px;
            border-radius: 32px;
            padding: 40px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            transform: translateY(20px);
            transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .modal-overlay.visible .card {
            transform: translateY(0);
        }

        h1 {
            color: var(--dark);
            font-weight: 900;
            font-size: 42px;
            margin: 0 0 15px 0;
            line-height: 1;
        }

        p {
            color: #747D8C;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 30px;
            line-height: 1.5;
        }

        .tutorial-visual {
            background: #F1F2F6;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 30px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            border: 4px dashed #CED6E0;
        }

        .word-sample {
            font-size: 22px;
            color: var(--dark);
            font-weight: 800;
        }

        .p-highlight { color: var(--primary); font-size: 26px; }

        .btn-primary {
            background: var(--secondary);
            color: white;
            border: none;
            width: 100%;
            padding: 22px;
            border-radius: 20px;
            font-family: 'Nunito', sans-serif;
            font-weight: 900;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 10px 0 #219d53;
            transition: transform 0.1s, box-shadow 0.1s;
            /* iOS: Fixes sticky hover states on touch */
            -webkit-tap-highlight-color: transparent;
        }

        .btn-primary:active {
            transform: translateY(6px);
            box-shadow: 0 4px 0 #219d53;
        }

        .btn-primary.red {
            background: var(--primary);
            box-shadow: 0 10px 0 #c23636;
        }
        .btn-primary.red:active { box-shadow: 0 4px 0 #c23636; }

    </style>
</head>
<body>

    <audio id="sfx-correct" src="p-sound.mp3" preload="auto"></audio>
    <audio id="sfx-wrong" src="wrong-sound.mp3" preload="auto"></audio>
    <audio id="sfx-lose" src="ohoh-sound.mp3" preload="auto"></audio>

    <canvas id="bg-canvas"></canvas>

    <div id="ui-layer">
        <div class="hud-header">
            <div class="progress-pill">
                <div class="progress-label">Pizza Progress</div>
                <div class="stars-container" id="starsDisplay">
                    <div class="star">‚òÖ</div>
                    <div class="star">‚òÖ</div>
                    <div class="star">‚òÖ</div>
                    <div class="star">‚òÖ</div>
                    <div class="star">‚òÖ</div>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-start" class="modal-overlay visible">
        <div class="card">
            <div style="font-size: 70px; margin-bottom: 10px;">üë®‚Äçüç≥</div>
            <h1>Chef's Challenge</h1>
            <p>Catch ingredients starting with <strong>P</strong>!</p>
            <div class="tutorial-visual">
                <div class="word-sample"><span class="p-highlight">P</span>izza</div>
                <div class="word-sample"><span class="p-highlight">P</span>asta</div>
            </div>
            <button class="btn-primary" id="btn-start">Start Cooking!</button>
        </div>
    </div>

    <div id="modal-win" class="modal-overlay">
        <div class="card">
            <div style="font-size: 80px; margin-bottom: 20px;">üçï‚ú®</div>
            <h1>Perfect!</h1>
            <p>The pizza looks delicious!</p>
            <button class="btn-primary" id="btn-restart-win">Cook Another</button>
        </div>
    </div>

    <div id="modal-lose" class="modal-overlay">
        <div class="card">
            <div style="font-size: 80px; margin-bottom: 20px;">üî•</div>
            <h1>Oh No!</h1>
            <p>Those weren't <strong>P</strong> ingredients!</p>
            <button class="btn-primary red" id="btn-restart-lose">Try Again</button>
        </div>
    </div>

    <canvas id="game-canvas"></canvas>

    <script>
        /**
         * HASBRO DIGITAL - ENGINE V4 (iPad Certified)
         */
        const CONFIG = {
            colors: {
                primary: '#FF4757',
                success: '#2ED573',
                text: '#2F3542',
                highlight: '#FFA502'
            },
            physics: {
                gravity: 0.5,
                drag: 0.95,
            },
            gameplay: {
                maxLives: 3,
                maxScore: 5,
                spawnRate: 90 
            }
        };

        // --- DATA ASSETS ---
        const ASSETS = {
            targets: [
                { word: "Pizza", emoji: "üçï" },
                { word: "Pepperoni", emoji: "ü•©" },
                { word: "Pie", emoji: "ü•ß" },
                { word: "Popcorn", emoji: "üçø" },
                { word: "Peach", emoji: "üçë" },
                { word: "Pear", emoji: "üçê" },
                { word: "Pineapple", emoji: "üçç" },
                { word: "Pickle", emoji: "ü•í" },
                { word: "Pepper", emoji: "üå∂Ô∏è" },
                { word: "Pea", emoji: "üü¢" },
                { word: "Pancake", emoji: "ü•û" },
                { word: "Pasta", emoji: "üçù" }
            ],
            distractors: [
                { word: "Burger", emoji: "üçî" },
                { word: "Taco", emoji: "üåÆ" },
                { word: "Apple", emoji: "üçé" },
                { word: "Banana", emoji: "üçå" },
                { word: "Donut", emoji: "üç©" },
                { word: "Egg", emoji: "ü•ö" },
                { word: "Sushi", emoji: "üç£" },
                { word: "Corn", emoji: "üåΩ" },
                { word: "Grapes", emoji: "üçá" },
                { word: "Cookie", emoji: "üç™" }
            ]
        };

        // --- GAME ENGINE ---
        class GameEngine {
            constructor() {
                this.canvas = document.getElementById('game-canvas');
                this.bgCanvas = document.getElementById('bg-canvas');
                this.ctx = this.canvas.getContext('2d');
                this.bgCtx = this.bgCanvas.getContext('2d');
                
                this.width = window.innerWidth;
                this.height = window.innerHeight;
                
                this.state = 'MENU';
                this.entities = [];
                this.particles = [];
                this.pizzaToppings = [];
                
                this.score = 0;
                this.lives = 3;
                this.frame = 0;
                
                this.initListeners();
                this.resize();
                
                this.loop = this.loop.bind(this);
                requestAnimationFrame(this.loop);
            }

            initListeners() {
                // Handle Window Resize / Rotation
                window.addEventListener('resize', () => {
                    this.resize();
                    // On mobile rotation, sometimes height needs a delay to recalculate
                    setTimeout(() => this.resize(), 200);
                });
                
                // Unified Input Handler
                const handleInput = (e) => {
                    if (this.state !== 'PLAYING') return;
                    
                    // Crucial for iPad: Prevent scrolling/zooming while tapping
                    if(e.cancelable) e.preventDefault(); 
                    
                    const rect = this.canvas.getBoundingClientRect();
                    let points = [];

                    // Support multi-touch
                    if (e.changedTouches) {
                        for (let i = 0; i < e.changedTouches.length; i++) {
                            const t = e.changedTouches[i];
                            points.push({ x: t.clientX - rect.left, y: t.clientY - rect.top });
                        }
                    } else {
                        points.push({ x: e.clientX - rect.left, y: e.clientY - rect.top });
                    }

                    // Check collisions for all touch points
                    points.forEach(p => {
                        for (let i = this.entities.length - 1; i >= 0; i--) {
                            const ent = this.entities[i];
                            if (ent.hitTest(p.x, p.y)) {
                                this.handleInteraction(ent, i);
                                return; // Handle one entity per touch point
                            }
                        }
                    });
                };

                // Add listeners with passive: false to allow preventDefault
                this.canvas.addEventListener('mousedown', handleInput);
                this.canvas.addEventListener('touchstart', handleInput, {passive: false});

                // Button Handlers (using click is fine for UI buttons, fastclick not needed for modern browsers)
                document.getElementById('btn-start').onclick = () => this.startGame();
                document.getElementById('btn-restart-win').onclick = () => this.startGame();
                document.getElementById('btn-restart-lose').onclick = () => this.startGame();
            }

            resize() {
                this.width = window.innerWidth;
                this.height = window.innerHeight;
                
                // High DPI display support (Retina screens)
                const dpr = window.devicePixelRatio || 1;
                
                this.canvas.width = this.width * dpr;
                this.canvas.height = this.height * dpr;
                this.ctx.scale(dpr, dpr);
                this.canvas.style.width = this.width + "px";
                this.canvas.style.height = this.height + "px";

                this.bgCanvas.width = this.width * dpr;
                this.bgCanvas.height = this.height * dpr;
                this.bgCtx.scale(dpr, dpr);
                this.bgCanvas.style.width = this.width + "px";
                this.bgCanvas.style.height = this.height + "px";
                
                this.cx = this.width / 2;
                this.cy = this.height / 2;
            }

            startGame() {
                this.score = 0;
                this.lives = CONFIG.gameplay.maxLives;
                this.entities = [];
                this.particles = [];
                this.pizzaToppings = [];
                this.state = 'PLAYING';
                this.frame = 0;
                
                this.updateStars();
                this.hideModals();
                
                setTimeout(() => this.spawnEntity(), 100);
                
                // Audio Warmup (Mobile Safari requirement)
                ['sfx-correct', 'sfx-wrong', 'sfx-lose'].forEach(id => {
                    const s = document.getElementById(id);
                    if(s) { 
                        s.muted = true; 
                        s.play().then(() => { 
                            s.pause(); 
                            s.currentTime=0; 
                            s.muted=false; 
                        }).catch(()=>{}); 
                    }
                });
            }

            hideModals() {
                document.querySelectorAll('.modal-overlay').forEach(el => el.classList.remove('visible'));
            }

            showModal(id) {
                document.getElementById(id).classList.add('visible');
            }

            handleInteraction(entity, index) {
                this.entities.splice(index, 1);

                if (entity.isTarget) {
                    // CORRECT
                    this.score++;
                    this.playAudio('sfx-correct'); // Play correct sound
                    this.spawnConfetti(entity.x, entity.y, CONFIG.colors.success);
                    this.createFlyingTopping(entity);
                    
                    if (this.score >= CONFIG.gameplay.maxScore) {
                        this.state = 'WIN_PENDING';
                        setTimeout(() => {
                            this.state = 'WIN';
                            this.showModal('modal-win');
                            this.spawnConfetti(this.cx, this.cy, '#FFD700', 100);
                        }, 2000);
                    }
                } else {
                    // WRONG
                    this.lives--;
                    this.playAudio('sfx-wrong'); // Play WRONG sound
                    this.shakeScreen();
                    this.spawnConfetti(entity.x, entity.y, CONFIG.colors.primary); 
                    
                    if (this.lives <= 0) {
                        // GAME OVER
                        this.state = 'LOSE';
                        this.playAudio('sfx-lose'); // Play LOSE sound
                        setTimeout(() => this.showModal('modal-lose'), 500);
                    }
                }
                this.updateStars();
            }

            createFlyingTopping(sourceEntity) {
                this.particles.push({
                    type: 'topping_flight',
                    x: sourceEntity.x,
                    y: sourceEntity.y,
                    emoji: sourceEntity.data.emoji,
                    startX: sourceEntity.x,
                    startY: sourceEntity.y,
                    targetX: this.cx + (Math.random()-0.5)*100,
                    targetY: this.cy + (Math.random()-0.5)*100,
                    progress: 0
                });
            }

            spawnEntity() {
                const isTarget = Math.random() > 0.4;
                const pool = isTarget ? ASSETS.targets : ASSETS.distractors;
                const data = pool[Math.floor(Math.random() * pool.length)];
                
                const side = Math.floor(Math.random() * 4);
                let x, y;
                const buffer = 100;

                switch(side) {
                    case 0: x = Math.random()*(this.width-100)+50; y = -buffer; break;
                    case 1: x = this.width+buffer; y = Math.random()*(this.height-100)+50; break;
                    case 2: x = Math.random()*(this.width-100)+50; y = this.height+buffer; break;
                    case 3: x = -buffer; y = Math.random()*(this.height-100)+50; break;
                }
                
                const angle = Math.atan2(this.cy - y, this.cx - x) + (Math.random() - 0.5) * 0.5;
                const speed = 2.5;

                this.entities.push(new BubbleEntity(x, y, speed, angle, data, isTarget));
            }

            spawnConfetti(x, y, color, amount = 20) {
                for (let i = 0; i < amount; i++) {
                    this.particles.push({
                        type: 'confetti',
                        x: x,
                        y: y,
                        vx: (Math.random() - 0.5) * 15,
                        vy: (Math.random() - 0.5) * 15 - 5,
                        color: color,
                        size: Math.random() * 8 + 4,
                        life: 1.0,
                        rotation: Math.random() * Math.PI,
                        rotSpeed: (Math.random() - 0.5) * 0.2
                    });
                }
            }

            shakeScreen() {
                this.canvas.style.transform = `translate(${Math.random()*10-5}px, ${Math.random()*10-5}px)`;
                setTimeout(() => this.canvas.style.transform = 'none', 150);
            }

            playAudio(id) {
                const el = document.getElementById(id);
                if(el) { el.currentTime = 0; el.play().catch(e=>{}); }
            }

            updateStars() {
                const stars = document.querySelectorAll('.star');
                stars.forEach((s, i) => {
                    if (i < this.score) s.classList.add('active');
                    else s.classList.remove('active');
                });
            }

            drawBackground() {
                this.bgCtx.fillStyle = '#2F3542';
                this.bgCtx.fillRect(0,0,this.width, this.height);
                
                this.bgCtx.fillStyle = '#383F4E';
                const time = Date.now() / 8000;
                const step = 80;
                
                for(let x = 0; x < this.width + step; x += step) {
                    for(let y = 0; y < this.height + step; y += step) {
                        const offX = Math.sin(time + y) * 15;
                        const offY = Math.cos(time + x) * 15;
                        this.bgCtx.beginPath();
                        this.bgCtx.arc(x + offX, y + offY, 8, 0, Math.PI*2);
                        this.bgCtx.fill();
                    }
                }
            }

            drawPizza() {
                this.ctx.save();
                this.ctx.translate(this.cx, this.cy);
                this.ctx.rotate(this.frame * 0.002);
                
                // Shadow
                this.ctx.beginPath();
                this.ctx.arc(10, 10, 150, 0, Math.PI*2);
                this.ctx.fillStyle = "rgba(0,0,0,0.3)";
                this.ctx.fill();

                // Crust
                this.ctx.beginPath();
                this.ctx.arc(0, 0, 150, 0, Math.PI*2);
                this.ctx.fillStyle = "#E1B12C";
                this.ctx.fill();
                this.ctx.strokeStyle = "#C69B22";
                this.ctx.lineWidth = 5;
                this.ctx.stroke();

                // Sauce
                this.ctx.beginPath();
                this.ctx.arc(0, 0, 135, 0, Math.PI*2);
                this.ctx.fillStyle = "#EB4D4B";
                this.ctx.fill();

                // Cheese
                let grad = this.ctx.createRadialGradient(0,0,50,0,0,130);
                grad.addColorStop(0, '#F6E58D');
                grad.addColorStop(1, '#F0932B');
                this.ctx.beginPath();
                this.ctx.arc(0, 0, 125, 0, Math.PI*2);
                this.ctx.fillStyle = grad;
                this.ctx.fill();

                // Toppings
                this.pizzaToppings.forEach(top => {
                    this.ctx.save();
                    this.ctx.translate(top.x, top.y);
                    this.ctx.rotate(top.r);
                    this.ctx.font = "40px Nunito";
                    this.ctx.textAlign = "center";
                    this.ctx.textBaseline = "middle";
                    this.ctx.fillText(top.emoji, 0, 0);
                    this.ctx.restore();
                });

                this.ctx.restore();
            }

            loop() {
                this.frame++;
                this.drawBackground();
                this.ctx.clearRect(0, 0, this.width, this.height);

                this.drawPizza();

                if (this.state === 'PLAYING') {
                    if (this.frame % CONFIG.gameplay.spawnRate === 0) {
                        this.spawnEntity();
                    }
                }

                // Particles
                for(let i=this.particles.length-1; i>=0; i--) {
                    const p = this.particles[i];
                    
                    if(p.type === 'topping_flight') {
                        p.progress += 0.04;
                        const x = p.startX + (p.targetX - p.startX) * p.progress;
                        const y = p.startY + (p.targetY - p.startY) * p.progress - Math.sin(p.progress * Math.PI) * 200; 
                        const scale = 1 + Math.sin(p.progress * Math.PI) * 0.5;

                        this.ctx.save();
                        this.ctx.translate(x, y);
                        this.ctx.scale(scale, scale);
                        this.ctx.font = "50px Nunito";
                        this.ctx.textAlign = "center";
                        this.ctx.textBaseline = "middle";
                        this.ctx.fillText(p.emoji, 0, 0);
                        this.ctx.restore();

                        if(p.progress >= 1) {
                            this.pizzaToppings.push({
                                x: p.targetX - this.cx,
                                y: p.targetY - this.cy,
                                emoji: p.emoji,
                                r: Math.random() * Math.PI * 2
                            });
                            this.spawnConfetti(p.targetX, p.targetY, '#FFF', 5);
                            this.particles.splice(i, 1);
                        }
                    } 
                    else if (p.type === 'confetti') {
                        p.x += p.vx;
                        p.y += p.vy;
                        p.vy += CONFIG.physics.gravity;
                        p.vx *= CONFIG.physics.drag;
                        p.life -= 0.02;
                        p.rotation += p.rotSpeed;

                        if (p.life <= 0) {
                            this.particles.splice(i, 1);
                            continue;
                        }

                        this.ctx.save();
                        this.ctx.translate(p.x, p.y);
                        this.ctx.rotate(p.rotation);
                        this.ctx.globalAlpha = p.life;
                        this.ctx.fillStyle = p.color;
                        this.ctx.fillRect(-p.size/2, -p.size/2, p.size, p.size);
                        this.ctx.restore();
                    }
                }

                // Entities
                for(let i=this.entities.length-1; i>=0; i--) {
                    const ent = this.entities[i];
                    ent.update();
                    ent.draw(this.ctx);

                    const buffer = 200;
                    if (ent.x < -buffer || ent.x > this.width + buffer || 
                        ent.y < -buffer || ent.y > this.height + buffer) {
                        this.entities.splice(i, 1);
                    }
                }

                requestAnimationFrame(this.loop);
            }
        }

        // --- ENTITY CLASS ---
        class BubbleEntity {
            constructor(x, y, speed, angle, data, isTarget) {
                this.x = x;
                this.y = y;
                this.vx = Math.cos(angle) * speed;
                this.vy = Math.sin(angle) * speed;
                this.data = data;
                this.isTarget = isTarget;
                this.size = 65; 
                this.scale = 0;
                this.maxScale = 1;
                this.wobble = Math.random() * Math.PI * 2;
            }

            hitTest(mx, my) {
                const dist = Math.hypot(mx - this.x, my - this.y);
                return dist < this.size;
            }

            update() {
                this.x += this.vx;
                this.y += this.vy;
                if (this.scale < this.maxScale) this.scale += 0.1; 
                this.wobble += 0.03;
            }

            draw(ctx) {
                ctx.save();
                ctx.translate(this.x, this.y + Math.sin(this.wobble) * 5);
                ctx.scale(this.scale, this.scale);

                // Bubble Body
                ctx.beginPath();
                ctx.arc(0, 0, this.size, 0, Math.PI*2);
                ctx.fillStyle = "white";
                ctx.shadowColor = "rgba(0,0,0,0.15)";
                ctx.shadowBlur = 15;
                ctx.shadowOffsetY = 8;
                ctx.fill();
                
                ctx.shadowColor = "transparent";
                ctx.strokeStyle = "#F1F2F6";
                ctx.lineWidth = 3;
                ctx.stroke();

                // Emoji
                ctx.font = "60px Nunito";
                ctx.textAlign = "center";
                ctx.textBaseline = "middle";
                ctx.fillText(this.data.emoji, 0, -15);

                // Text Scaffolding
                const word = this.data.word;
                const first = word.charAt(0);
                const rest = word.slice(1);
                
                ctx.textAlign = "left";
                
                ctx.font = "900 32px Nunito";
                const w1 = ctx.measureText(first).width;
                ctx.font = "700 24px Nunito";
                const w2 = ctx.measureText(rest).width;
                const totalW = w1 + w2;
                const startX = -totalW / 2;
                const textY = 35;

                ctx.font = "900 32px Nunito";
                ctx.fillStyle = first.toUpperCase() === 'P' ? CONFIG.colors.primary : '#57606F';
                ctx.fillText(first, startX, textY);

                ctx.font = "700 24px Nunito";
                ctx.fillStyle = "#A4B0BE";
                ctx.fillText(rest, startX + w1, textY);

                ctx.restore();
            }
        }

        window.onload = () => new GameEngine();

    </script>
</body>
</html>